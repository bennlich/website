(function(o){function M(n,p){var v=n[0]-p[0],e=n[1]-p[1];return v*v+e*e}function R(n){for(var p=0,v=0,e=0,h=n.length-3;e<h;e+=2){p+=n[e];v+=n[e+1]}n=(n.length-2)*2;return[p/n<<0,v/n<<0]}function xa(n){var p=n.length/2,v=new La(p),e=0,h=p-1,j,t,q,D,J=[],N=[],K=[];for(v[e]=v[h]=1;h;){t=0;for(j=e+1;j<h;j++){q=n[j*2];var $=n[j*2+1],O=n[e*2],U=n[e*2+1],aa=n[h*2],G=n[h*2+1],u=aa-O,z=G-U,E=void 0;if(u!==0||z!==0){E=((q-O)*u+($-U)*z)/(u*u+z*z);if(E>1){O=aa;U=G}else if(E>0){O+=u*E;U+=z*E}}u=q-O;z=$-U;q=u*
u+z*z;if(q>t){D=j;t=q}}if(t>2){v[D]=1;J.push(e);N.push(D);J.push(D);N.push(h)}e=J.pop();h=N.pop()}for(j=0;j<p;j++)v[j]&&K.push(n[j*2],n[j*2+1]);return K}var Ma=Ma||Array,La=La||Array,ca=Math,Pa=ca.exp,Qa=ca.log,Ra=ca.sin,Sa=ca.cos,Ea=ca.tan,Ta=ca.atan,ka=ca.min,Fa=ca.max,ya=o.document,V=function(){function n(e,h,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return e+(h-e)*6*j;if(j<0.5)return h;if(j<2/3)return e+(h-e)*(2/3-j)*6;return e}function p(e,h,j,t){this.r=e;this.g=h;this.b=j;this.a=arguments.length<
4?1:t}var v=p.prototype;v.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};v.adjustLightness=function(e){var h=V.toHSLA(this);h.l*=e;h.l=Math.min(1,Math.max(0,h.l));var j,t;if(h.s===0)e=j=t=h.l;else{t=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var q=2*h.l-t;e=n(q,t,h.h+1/3);j=n(q,t,h.h);t=n(q,t,h.h-1/3)}return new V(e*255<<0,j*255<<0,t*255<<0,h.a)};v.adjustAlpha=function(e){return new V(this.r,this.g,this.b,this.a*e)};p.parse=function(e){e+="";if(~e.indexOf("#")){e=
e.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new V(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),e[4]?parseInt(e[4],16)/255:1)}if(e=e.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new V(parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10),e[4]?parseFloat(e[5],10):1)};p.toHSLA=function(e){var h=e.r/255,j=e.g/255,t=e.b/255,q=Math.max(h,j,t),D=Math.min(h,j,t),J,N=(q+D)/2,K;if(q===D)J=D=0;else{K=q-D;D=N>0.5?K/(2-q-D):K/(q+D);switch(q){case h:J=(j-t)/K+(j<t?6:0);break;case j:J=
(t-h)/K+2;break;case t:J=(h-j)/K+4;break}J/=6}return{h:J,s:D,l:N,a:e.a}};return p}(),Ua=function(){var n=Math,p=n.sin,v=n.cos,e=n.tan,h=n.asin,j=n.atan2,t=n.PI,q=180/t,D=357.5291/q,J=0.98560028/q,N=1.9148/q,K=0.02/q,$=3.0E-4/q,O=102.9372/q,U=23.45/q,aa=280.16/q,G=360.9856235/q;return function(u,z,E){E=-E/q;z=z/q;u=u.valueOf()/864E5-0.5+2440588;var F=D+J*(u-2451545),H=N*p(F)+K*p(2*F)+$*p(3*F);H=F+O+H+t;F=h(p(H)*p(U));H=j(p(H)*v(U),v(H));E=aa+G*(u-2451545)-E-H;return{altitude:h(p(z)*p(F)+v(z)*v(F)*
v(E)),azimuth:j(p(E),v(E)*p(z)-e(F)*v(z))-t/2}}}(),la=Math.PI,Na=la/2,Va=la/4,Wa=180/la,Xa=256,Ga=14,ma="latitude",na="longitude",S=0,P=1,T=2,da=3,za=4,ga=5,ba=6;o.OSMBuildings=function(n){function p(a,c){var d={};a/=oa;c/=oa;d[ma]=c<=0?90:c>=1?-90:Wa*(2*Ta(Pa(la*(1-2*c)))-Na);d[na]=(a===1?1:(a%1+1)%1)*360-180;return d}function v(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(d,b){return c[b]})}function e(a,c){var d=new XMLHttpRequest;d.onreadystatechange=function(){if(d.readyState===4)!d.status||
d.status<200||d.status>299||d.responseText&&c(JSON.parse(d.responseText))};d.open("GET",a);d.send(null);return d}function h(){if(!(!Ha||Q<Ga)){var a=p(F-z,H-E),c=p(F+G+z,H+u+E);Aa&&Aa.abort();Aa=e(v(Ha,{w:a[na],n:a[ma],e:c[na],s:c[ma],z:Q}),j)}}function j(a){var c,d,b,f=[],g,i=g=0;ia=Ga;N(Q);Aa=null;if(!(!a||a.meta.z!==Q)){b=a.meta;d=a.data;if(C&&x&&C.z===b.z){g=C.x-b.x;i=C.y-b.y;a=0;for(c=x.length;a<c;a++)f[a]=x[a][T][0]+g+","+(x[a][T][1]+i)}C=b;x=[];a=0;for(c=d.length;a<c;a++){b=[];if(!(d[a][P]>
pa)){g=xa(d[a][T]);if(!(g.length<8)){b[T]=g;b[za]=R(g);b[S]=ka(d[a][S],pa);b[P]=d[a][P];g=b[T][0]+","+b[T][1];b[ga]=!(f&&~f.indexOf(g));b[da]=[];b[ba]=[];x.push(b)}}}K()}}function t(a,c){var d=[],b,f,g,i,k,m,l,A,w,I=Ia-Q;b=0;for(f=a.length;b<f;b++){k=a[b];A=k[P]>>I;if(!(A>pa)){m=k[T];w=new Ma(m.length);g=0;for(i=m.length-1;g<i;g+=2){l=m[g+1];var y=ka(1,Fa(0,0.5-Qa(Ea(Va+Na*m[g]/180))/la/2));l={x:(l/360+0.5)*oa<<0,y:y*oa<<0};w[g]=l.x;w[g+1]=l.y}w=xa(w);if(!(w.length<8)){i=[];i[T]=w;i[za]=R(w);i[S]=
ka(k[S]>>I,pa);i[P]=A;i[ga]=c;i[da]=k[da];i[ba]=[];for(g=0;g<3;g++)if(i[da][g])i[ba][g]=i[da][g].adjustAlpha(X)+"";d.push(i)}}}return d}function q(a,c){if(typeof a==="object")J(a,!c);else{var d=ya.documentElement,b=ya.createElement("script");o.jsonpCallback=function(f){delete o.jsonpCallback;d.removeChild(b);J(f,!c)};d.insertBefore(b,d.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function D(a,c,d){if(d===undefined)d=[];var b,f,g,i=a[0]?a:a.features,k,m,l,A,w,I=c?1:0,y=c?0:1;if(i){b=0;
for(a=i.length;b<a;b++)D(i[b],c,d);return d}if(a.type==="Feature"){k=a.geometry;b=a.properties}if(k.type==="Polygon")m=[k.coordinates];if(k.type==="MultiPolygon")m=k.coordinates;if(m){c=b.height;if(b.color||b.wallColor)A=V.parse(b.color||b.wallColor);if(b.roofColor)w=V.parse(b.roofColor);b=0;for(a=m.length;b<a;b++){i=m[b][0];l=[];f=k=0;for(g=i.length;f<g;f++){l.push(i[f][I],i[f][y]);k+=c||i[f][2]||0}if(k){f=[];g=T;var r=void 0,s=void 0,B=void 0,L=void 0,Y=0,Z=void 0,qa=void 0;Z=0;for(qa=l.length-
3;Z<qa;Z+=2){r=l[Z];s=l[Z+1];B=l[Z+2];L=l[Z+3];Y+=r*L-B*s}if((Y/2>0?"CW":"CCW")==="CW")l=l;else{r=[];for(s=l.length-2;s>=0;s-=2)r.push(l[s],l[s+1]);l=r}f[g]=l;f[S]=k/i.length<<0;f[da]=[A||null,A?A.adjustLightness(0.8):null,w?w:A?A.adjustLightness(1.2):ha];d.push(f)}}}return d}function J(a,c){if(a){ra=D(a,c);ia=0;N(Q);C={n:90,w:-180,s:-90,e:180,x:0,y:0,z:Q};x=t(ra,true);K()}else{ra=null;O()}}function N(a){var c,d,b;Q=a;oa=Xa<<Q;a=Q;c=ia;d=Ia;a=ka(Fa(a,c),d);X=1-ka(Fa(0+(a-c)/(d-c)*0.4,0),0.4);Ja=ea.adjustAlpha(X)+
"";sa=Ba.adjustAlpha(X)+"";ta=ha.adjustAlpha(X)+"";if(x){a=0;for(c=x.length;a<c;a++){b=x[a];b[ba]=[];for(d=0;d<3;d++)if(b[da][d])b[ba][d]=b[da][d].adjustAlpha(X)+""}}}function K(){clearInterval(Ka);fa=0;Ca.render();Ka=setInterval(function(){fa+=0.1;if(fa>1){clearInterval(Ka);fa=1;for(var a=0,c=x.length;a<c;a++)x[a][ga]=0}Da.render();O()},33)}function $(){Da.render();Ca.render();O()}function O(){W.clearRect(0,0,G,u);if(!(!C||!x||Q<ia||ua)){var a,c,d,b,f,g,i,k,m,l=F-C.x,A=H-C.y,w=Ca.getMaxHeight(),
I=[va+l,wa+A],y,r,s,B,L,Y;x.sort(function(Z,qa){return M(qa[za],I)/qa[S]-M(Z[za],I)/Z[S]});a=0;for(c=x.length;a<c;a++){f=x[a];if(!(f[S]<=w)){r=false;g=f[T];y=[];d=0;for(b=g.length-1;d<b;d+=2){y[d]=k=g[d]-l;y[d+1]=m=g[d+1]-A;r||(r=k>0&&k<G&&m>0&&m<u)}if(r){d=f[ga]?f[S]*fa:f[S];g=ja/(ja-d);if(f[P]){d=f[ga]?f[P]*fa:f[P];i=ja/(ja-d)}k=[];d=0;for(b=y.length-3;d<b;d+=2){m=y[d];s=y[d+1];r=y[d+2];B=y[d+3];L=aa(m,s,g);Y=aa(r,B,g);if(f[P]){s=aa(m,s,i);B=aa(r,B,i);m=s.x;s=s.y;r=B.x;B=B.y}if((r-m)*(L.y-s)>(L.x-
m)*(B-s)){W.fillStyle=m<r&&s<B||m>r&&s>B?f[ba][1]||sa:f[ba][0]||Ja;U([r,B,m,s,L.x,L.y,Y.x,Y.y])}k[d]=L.x;k[d+1]=L.y}W.fillStyle=f[ba][2]||ta;W.strokeStyle=f[ba][1]||sa;U(k,true)}}}}}function U(a,c){if(a.length){W.beginPath();W.moveTo(a[0],a[1]);for(var d=2,b=a.length;d<b;d+=2)W.lineTo(a[d],a[d+1]);W.closePath();c&&W.stroke();W.fill()}}function aa(a,c,d){return{x:(a-va)*d+va<<0,y:(c-wa)*d+wa<<0}}var G=0,u=0,z=0,E=0,F=0,H=0,Q,oa,Aa,W,Ha,ea=new V(200,190,180),Ba=ea.adjustLightness(0.8),ha=ea.adjustLightness(1.2),
Ja=ea+"",sa=Ba+"",ta=ha+"",ra,C,x,fa=1,Ka,X=1,ia=Ga,Ia=20,pa,va,wa,ja,ua,Oa={container:null,items:[],init:function(a){var c=this.container=ya.createElement("DIV");c.style.pointerEvents="none";c.style.position="absolute";c.style.left=0;c.style.top=0;Da.init(this.add());Ca.init(this.add());W=this.add();a.appendChild(c);return c},add:function(){var a=ya.createElement("CANVAS");a.style.webkitTransform="translate3d(0,0,0)";a.style.imageRendering="optimizeSpeed";a.style.position="absolute";a.style.left=
0;a.style.top=0;var c=a.getContext("2d");c.lineCap="round";c.lineJoin="round";c.lineWidth=1;try{c.mozImageSmoothingEnabled=false}catch(d){}this.items.push(a);this.container.appendChild(a);return c},setSize:function(a,c){for(var d=this.items,b=0,f=d.length;b<f;b++){d[b].width=a;d[b].height=c}}},Da={context:null,color:new V(0,0,0),colorStr:this.color+"",date:null,alpha:1,length:0,directionX:0,directionY:0,init:function(a){this.context=a;this.setDate((new Date).setHours(10))},render:function(){var a=
this.context,c,d,b,f;a.clearRect(0,0,G,u);if(!(!C||!x||Q<ia||ua)){c=p(F+z,H+E);c=Ua(this.date,c.latitude,c.longitude);if(!(c.altitude<=0)){d=1/Ea(c.altitude);b=0.4/d;this.directionX=Sa(c.azimuth)*d;this.directionY=Ra(c.azimuth)*d;this.color.a=b;f=this.color+"";var g,i,k,m,l,A=F-C.x,w=H-C.y,I,y,r,s,B,L,Y=[];a.beginPath();c=0;for(d=x.length;c<d;c++){i=x[c];y=false;k=i[T];I=[];b=0;for(g=k.length-1;b<g;b+=2){I[b]=m=k[b]-A;I[b+1]=l=k[b+1]-w;y||(y=m>0&&m<G&&l>0&&l<u)}if(y){k=i[ga]?i[S]*fa:i[S];if(i[P])k=
i[ga]?i[P]*fa:i[P];m=null;b=0;for(g=I.length-3;b<g;b+=2){l=I[b];r=I[b+1];y=I[b+2];s=I[b+3];B=this.project(l,r,k);L=this.project(y,s,k);if(i[P]){r=this.project(l,r,k);s=this.project(y,s,k);l=r.x;r=r.y;y=s.x;s=s.y}if((y-l)*(B.y-r)>(B.x-l)*(s-r)){m===1&&a.lineTo(l,r);m=0;b||a.moveTo(l,r);a.lineTo(y,s)}else{m===0&&a.lineTo(B.x,B.y);m=1;b||a.moveTo(B.x,B.y);a.lineTo(L.x,L.y)}}a.closePath();Y.push(I)}}a.fillStyle=f;a.fill();a.globalCompositeOperation="destination-out";a.beginPath();c=0;for(d=Y.length;c<
d;c++){f=Y[c];a.moveTo(f[0],f[1]);b=2;for(g=f.length;b<g;b+=2)a.lineTo(f[b],f[b+1]);a.lineTo(f[0],f[1]);a.closePath()}a.fillStyle="#00ff00";a.fill();a.globalCompositeOperation="source-over"}}},project:function(a,c,d){return{x:a+this.directionX*d,y:c+this.directionY*d}},setDate:function(a){this.date=a;this.render()}},Ca={context:null,maxHeight:8,init:function(a){this.context=a},render:function(){var a=this.context;a.clearRect(0,0,G,u);if(!(!C||!x||Q<ia||ua)){var c,d,b,f,g,i,k,m=F-C.x,l=H-C.y,A,w;a.beginPath();
c=0;for(d=x.length;c<d;c++){b=x[c];w=false;g=b[T];A=[];b=0;for(f=g.length-1;b<f;b+=2){A[b]=i=g[b]-m;A[b+1]=k=g[b+1]-l;w||(w=i>0&&i<G&&k>0&&k<u)}if(w){b=0;for(f=A.length-3;b<f;b+=2){w=A[b];g=A[b+1];b?a.lineTo(w,g):a.moveTo(w,g)}a.closePath()}}a.fillStyle=ta;a.strokeStyle=sa;a.stroke();a.fill()}},getMaxHeight:function(){return this.maxHeight}};this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){ea=V.parse(a.color||a.wallColor);Ja=ea.adjustAlpha(X)+"";Ba=ea.adjustLightness(0.8);sa=Ba.adjustAlpha(X)+
"";ha=ea.adjustLightness(1.2);ta=ha.adjustAlpha(X)+""}if(a.roofColor){ha=V.parse(a.roofColor);ta=ha.adjustAlpha(X)+""}$();return this};this.geoJSON=function(a,c){q(a,c);return this};this.setCamOffset=function(a,c){va=z+a;wa=u+c};this.setMaxZoom=function(a){Ia=a};this.setDate=function(a){Da.setDate(a);return this};this.appendTo=function(a){return Oa.init(a)};this.loadData=h;this.onMoveEnd=function(){var a=p(F,H),c=p(F+G,H+u);$();if(C&&(a[ma]>C.n||a[na]<C.w||c[ma]<C.s||c[na]>C.e))h()};this.onZoomEnd=
function(a){ua=false;N(a.zoom);if(ra){x=t(ra);$()}else{O();h()}};this.onZoomStart=function(){ua=true;$()};this.setOrigin=function(a,c){F=a;H=c};this.setSize=function(a,c){G=a;u=c;z=G/2<<0;E=u/2<<0;va=z;wa=u;ja=G/1.5/Ea(45)<<0;Oa.setSize(G,u);pa=ja-50};this.setZoom=N;this.render=O;Ha=n};o.OSMBuildings.VERSION="0.1.8a";o.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(o){o=o||{};o.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,o)},setOrigin:function(){var o=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),M=this.map.resolution,R=this.maxExtent;this.osmb.setOrigin(Math.round((o.lon-R.left)/M),Math.round((R.top-
o.lat)/M))},setMap:function(o){this.map||OpenLayers.Layer.prototype.setMap(o);if(!this.osmb){this.osmb=new OSMBuildings(this.options.url);this.container=this.osmb.appendTo(this.div)}this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()},removeMap:function(o){this.container.parentNode.removeChild(this.container);OpenLayers.Layer.prototype.removeMap(o)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,
height:this.map.size.h})},moveTo:function(o,M,R){o=OpenLayers.Layer.prototype.moveTo(o,M,R);if(!R){R=parseInt(this.map.layerContainerDiv.style.left,10);var xa=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-R+"px";this.div.style.top=-xa+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);M?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return o},moveByPx:function(o,M){this.dxSum+=o;this.dySum+=M;var R=OpenLayers.Layer.prototype.moveByPx(o,
M);this.osmb.setCamOffset(this.dxSum,this.dySum);this.osmb.render();return R},geoJSON:function(o,M){return this.osmb.geoJSON(o,M)},setStyle:function(o){return this.osmb.setStyle(o)},setDate:function(o){return this.osmb.setDate(o)}});
