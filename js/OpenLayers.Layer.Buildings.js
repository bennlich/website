(function(l){function F(i){for(var m,x=[i[0],i[1]],c,f=[i[0],i[1]],j=2,p=i.length-3;j<p;j+=2){m=[i[j],i[j+1]];c=[i[j+2]||i[0],i[j+3]||i[1]];var t=x,q=t[0],u=t[1],G=c[0]-q,v=c[1]-u,y=void 0;if(G!==0||v!==0){y=((m[0]-q)*G+(m[1]-u)*v)/(G*G+v*v);if(y>1){q=c[0];u=c[1]}else if(y>0){q+=G*y;u+=v*y}}q=z(m,[q,u])*2;c=z(t,c);if(q*c>750){f.push(m[0],m[1]);x=m}}if(m[0]!==i[0]||m[1]!==i[1])f.push(i[0],i[1]);return f}function z(i,m){var x=i[0]-m[0],c=i[1]-m[1];return x*x+c*c}function ka(i){for(var m=0,x=0,c=0,f=
i.length-3;c<f;c+=2){m+=i[c];x+=i[c+1]}i=(i.length-2)*2;return[m/i<<0,x/i<<0]}var Ba=Ba||Array,Ga=Math.exp,Ha=Math.log,Ia=Math.tan,Ja=Math.atan,ra=Math.min,Ka=Math.max,sa=l.document,K=function(){function i(c,f,j){if(j<0)j+=1;if(j>1)j-=1;if(j<1/6)return c+(f-c)*6*j;if(j<0.5)return f;if(j<2/3)return c+(f-c)*(2/3-j)*6;return c}function m(c,f,j,p){this.r=c;this.g=f;this.b=j;this.a=arguments.length<4?1:p}var x=m.prototype;x.toString=function(){return"rgba("+[this.r,this.g,this.b,this.a.toFixed(2)].join(",")+
")"};x.adjustLightness=function(c){var f=K.toHSLA(this);f.l*=c;f.l=Math.min(1,Math.max(0,f.l));var j,p;if(f.s===0)c=j=p=f.l;else{p=f.l<0.5?f.l*(1+f.s):f.l+f.s-f.l*f.s;var t=2*f.l-p;c=i(t,p,f.h+1/3);j=i(t,p,f.h);p=i(t,p,f.h-1/3)}return new K(c*255<<0,j*255<<0,p*255<<0,f.a)};x.adjustAlpha=function(c){return new K(this.r,this.g,this.b,this.a*c)};m.parse=function(c){c+="";if(~c.indexOf("#")){c=c.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new K(parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],
16),c[4]?parseInt(c[4],16)/255:1)}if(c=c.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new K(parseInt(c[1],10),parseInt(c[2],10),parseInt(c[3],10),c[4]?parseFloat(c[5],10):1)};m.toHSLA=function(c){var f=c.r/255,j=c.g/255,p=c.b/255,t=Math.max(f,j,p),q=Math.min(f,j,p),u,G=(t+q)/2,v;if(t===q)u=q=0;else{v=t-q;q=G>0.5?v/(2-t-q):v/(t+q);switch(t){case f:u=(j-p)/v+(j<p?6:0);break;case j:u=(p-f)/v+2;break;case p:u=(f-j)/v+4;break}u/=6}return{h:u,s:q,l:G,a:c.a}};return m}(),aa=Math.PI,Ca=aa/
2,La=aa/4,Ma=180/aa,Na=256,ta=14,ua=400,Da=ua-50,ba="latitude",ca="longitude",P=0,L=1,S=2,la=3,ma=4,Q=5;l.OSMBuildings=function(i){function m(a,e){var b={};a/=da;e/=da;b[ba]=e<=0?90:e>=1?-90:Ma*(2*Ja(Ga(aa*(1-2*e)))-Ca);b[ca]=(a===1?1:(a%1+1)%1)*360-180;return b}function x(a,e){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return e[d]})}function c(a,e){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&e(JSON.parse(b.responseText))};
b.open("GET",a);b.send(null);return b}function f(){if(!(!va||J<ta)){var a=m(Z-ea,$-wa),e=m(Z+U+ea,$+R+wa);na&&na.abort();na=c(x(va,{w:a[ca],n:a[ba],e:e[ca],s:e[ba],z:J}),j)}}function j(a){var e,b,d,k=[],g,h=g=0;fa=ta;G(J);na=null;if(!(!a||a.meta.z!==J)){d=a.meta;b=a.data;if(A&&s&&A.z===d.z){g=A.x-d.x;h=A.y-d.y;a=0;for(e=s.length;a<e;a++)k[a]=s[a][L][0]+g+","+(s[a][L][1]+h)}A=d;s=[];a=0;for(e=b.length;a<e;a++){d=[];g=F(b[a][L]);if(!(g.length<8)){d[L]=g;d[la]=ka(g);d[P]=ra(b[a][P],Da);g=d[L][0]+","+
d[L][1];d[ma]=!(k&&~k.indexOf(g));d[S]=[];d[Q]=[];s.push(d)}}v()}}function p(a,e){var b=[],d,k,g,h,n,B,o,r,C=xa-J;d=0;for(k=a.length;d<k;d++){n=a[d];B=n[L];r=new Ba(B.length);g=0;for(h=B.length-1;g<h;g+=2){o=B[g+1];var M=ra(1,Ka(0,0.5-Ha(Ia(La+Ca*B[g]/180))/aa/2));o={x:(o/360+0.5)*da<<0,y:M*da<<0};r[g]=o.x;r[g+1]=o.y}r=F(r);if(!(r.length<8)){h=[];h[L]=r;h[la]=ka(r);h[P]=ra(n[P]>>C,Da);h[ma]=e;h[S]=n[S];h[Q]=[];for(g=0;g<3;g++)if(h[S][g])h[Q][g]=h[S][g].adjustAlpha(N)+"";b.push(h)}}return b}function t(a,
e){if(typeof a==="object")u(a,!e);else{var b=sa.documentElement,d=sa.createElement("script");l.jsonpCallback=function(k){delete l.jsonpCallback;b.removeChild(d);u(k,!e)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,"jsonpCallback")}}function q(a,e,b){if(b===undefined)b=[];var d,k,g,h=a[0]?a:a.features,n,B,o,r,C,M=e?1:0,H=e?0:1;if(h){d=0;for(a=h.length;d<a;d++)q(h[d],e,b);return b}if(a.type==="Feature"){n=a.geometry;d=a.properties}if(n.type==="Polygon")B=[n.coordinates];if(n.type==="MultiPolygon")B=
n.coordinates;if(B){e=d.height;if(d.color||d.wallColor)r=K.parse(d.color||d.wallColor);if(d.roofColor)C=K.parse(d.roofColor);d=0;for(a=B.length;d<a;d++){h=B[d][0];o=[];k=n=0;for(g=h.length;k<g;k++){o.push(h[k][M],h[k][H]);n+=e||h[k][2]||0}if(n){k=[];g=L;var I=void 0,D=void 0,O=void 0,ga=void 0,ha=0,V=void 0,Ea=void 0;V=0;for(Ea=o.length-3;V<Ea;V+=2){I=o[V];D=o[V+1];O=o[V+2];ga=o[V+3];ha+=I*ga-O*D}if((ha/2>0?"CW":"CCW")==="CW")o=o;else{I=[];for(D=o.length-2;D>=0;D-=2)I.push(o[D],o[D+1]);o=I}k[g]=o;
k[P]=n/h.length<<0;k[S]=[r||null,r?r.adjustLightness(0.8):null,C?C:r?r.adjustLightness(1.2):W];b.push(k)}}}return b}function u(a,e){if(a){ia=q(a,e);fa=0;G(J);A={n:90,w:-180,s:-90,e:180,x:0,y:0,z:J};s=p(ia,true);v()}else{ia=null;y()}}function G(a){var e,b,d;J=a;da=Na<<J;N=1-(J-fa)*0.3/(xa-fa);ya=T.adjustAlpha(N)+"";oa=pa.adjustAlpha(N)+"";qa=W.adjustAlpha(N)+"";if(s){a=0;for(e=s.length;a<e;a++){d=s[a];d[Q]=[];for(b=0;b<3;b++)if(d[S][b])d[Q][b]=d[S][b].adjustAlpha(N)+""}}}function v(){ja=0;clearInterval(za);
za=setInterval(function(){ja+=0.1;if(ja>1){clearInterval(za);ja=1;for(var a=0,e=s.length;a<e;a++)s[a][ma]=0}y()},33)}function y(){w.clearRect(0,0,U,R);if(A&&s)if(!(J<fa||Aa)){var a,e,b,d,k,g,h,n,B=Z-A.x,o=$-A.y,r=[X+B,Y+o],C,M,H,I,D,O;s.sort(function(ga,ha){return z(ha[la],r)/ha[P]-z(ga[la],r)/ga[P]});a=0;for(e=s.length;a<e;a++){k=s[a];H=false;g=k[L];C=[];b=0;for(d=g.length-1;b<d;b+=2){C[b]=h=g[b]-B;C[b+1]=n=g[b+1]-o;H||(H=h>0&&h<U&&n>0&&n<R)}if(H){b=k[ma]?k[P]*ja:k[P];g=ua/(ua-b);h=[];M=[];b=0;for(d=
C.length-3;b<d;b+=2){n=C[b];H=C[b+1];I=C[b+2];D=C[b+3];O={x:((n-X)*g+X<<0)+0.5,y:((H-Y)*g+Y<<0)+0.5};M={x:((I-X)*g+X<<0)+0.5,y:((D-Y)*g+Y<<0)+0.5};if((I-n)*(O.y-H)>(O.x-n)*(D-H)){M=[I+0.5,D+0.5,n+0.5,H+0.5,O.x,O.y,M.x,M.y];w.fillStyle=n<I&&H<D||n>I&&H>D?k[Q][1]||oa:k[Q][0]||ya;Fa(M)}h[b]=O.x;h[b+1]=O.y}w.fillStyle=k[Q][2]||qa;w.strokeStyle=k[Q][1]||oa;Fa(h,true)}}}}function Fa(a,e){if(a.length){w.beginPath();w.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)w.lineTo(a[b],a[b+1]);w.closePath();e&&
w.stroke();w.fill()}}var U=0,R=0,ea=0,wa=0,Z=0,$=0,J,da,na,E,w,va,T=new K(200,190,180),pa=T.adjustLightness(0.8),W=T.adjustLightness(1.2),ya=T+"",oa=pa+"",qa=W+"",ia,A,s,ja=1,za,N=1,fa=ta,xa=20,X,Y,Aa;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){T=K.parse(a.color||a.wallColor);ya=T.adjustAlpha(N)+"";pa=T.adjustLightness(0.8);oa=pa.adjustAlpha(N)+"";W=T.adjustLightness(1.2);qa=W.adjustAlpha(N)+""}if(a.roofColor){W=K.parse(a.roofColor);qa=W.adjustAlpha(N)+""}y();return this};this.geoJSON=
function(a,e){t(a,e);return this};this.setCamOffset=function(a,e){X=ea+a;Y=R+e};this.setMaxZoom=function(a){xa=a};this.createCanvas=function(a){E=sa.createElement("canvas");E.style.webkitTransform="translate3d(0,0,0)";E.style.imageRendering="optimizeSpeed";E.style.position="absolute";E.style.pointerEvents="none";E.style.left=0;E.style.top=0;a.appendChild(E);w=E.getContext("2d");w.lineCap="round";w.lineJoin="round";w.lineWidth=1;try{w.mozImageSmoothingEnabled=false}catch(e){}return E};this.destroyCanvas=
function(){E.parentNode.removeChild(E)};this.loadData=f;this.onMoveEnd=function(){var a=m(Z,$),e=m(Z+U,$+R);y();if(A&&(a[ba]>A.n||a[ca]<A.w||e[ba]<A.s||e[ca]>A.e))f()};this.onZoomEnd=function(a){Aa=false;G(a.zoom);if(ia){s=p(ia);y()}else{y();f()}};this.onZoomStart=function(){Aa=true;y()};this.render=y;this.setOrigin=function(a,e){Z=a;$=e};this.setSize=function(a,e){U=a;R=e;ea=U/2<<0;wa=R/2<<0;X=ea;Y=R;E.width=U;E.height=R};this.setZoom=G;va=i};l.OSMBuildings.VERSION="0.1.7a";l.OSMBuildings.ATTRIBUTION=
'&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
OpenLayers.Layer.Buildings=OpenLayers.Class(OpenLayers.Layer,{CLASS_NAME:"OpenLayers.Layer.Buildings",name:"OSM Buildings",attribution:OSMBuildings.ATTRIBUTION,isBaseLayer:false,alwaysInRange:true,dxSum:0,dySum:0,initialize:function(l){l=l||{};l.projection="EPSG:900913";OpenLayers.Layer.prototype.initialize(this.name,l)},setOrigin:function(){var l=this.map.getLonLatFromPixel(new OpenLayers.Pixel(0,0)),F=this.map.resolution,z=this.maxExtent;this.osmb.setOrigin(Math.round((l.lon-z.left)/F),Math.round((z.top-
l.lat)/F))},setMap:function(l){if(!this.map){OpenLayers.Layer.prototype.setMap(l);this.osmb=new OSMBuildings(this.options.url);this.osmb.createCanvas(this.div);this.osmb.setSize(this.map.size.w,this.map.size.h);this.osmb.setZoom(this.map.zoom);this.setOrigin();this.osmb.loadData()}},removeMap:function(l){this.osmb.destroyCanvas();this.osmb=null;OpenLayers.Layer.prototype.removeMap(l)},onMapResize:function(){OpenLayers.Layer.prototype.onMapResize();this.osmb.onResize({width:this.map.size.w,height:this.map.size.h})},
moveTo:function(l,F,z){l=OpenLayers.Layer.prototype.moveTo(l,F,z);if(!z){z=parseInt(this.map.layerContainerDiv.style.left,10);var ka=parseInt(this.map.layerContainerDiv.style.top,10);this.div.style.left=-z+"px";this.div.style.top=-ka+"px"}this.setOrigin();this.dySum=this.dxSum=0;this.osmb.setCamOffset(this.dxSum,this.dySum);F?this.osmb.onZoomEnd({zoom:this.map.zoom}):this.osmb.onMoveEnd();return l},moveByPx:function(l,F){this.dxSum+=l;this.dySum+=F;var z=OpenLayers.Layer.prototype.moveByPx(l,F);this.osmb.setCamOffset(this.dxSum,
this.dySum);this.osmb.render();return z},geoJSON:function(l,F){return this.osmb.geoJSON(l,F)},setStyle:function(l){return this.osmb.setStyle(l)}});
