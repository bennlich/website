(function(j){function J(p,y){var C=p[0]-y[0],f=p[1]-y[1];return C*C+f*f}function Ua(p){for(var y=0,C=0,f=0,h=p.length-3;f<h;f+=2){y+=p[f];C+=p[f+1]}p=(p.length-2)*2;return[y/p<<0,C/p<<0]}function Va(p){var y=p.length/2,C=new Wa(y),f=0,h=y-1,k,u,z,E,K=[],Z=[],H=[];for(C[f]=C[h]=1;h;){u=0;for(k=f+1;k<h;k++){z=p[k*2];var za=p[k*2+1],aa=p[f*2],F=p[f*2+1],ja=p[h*2],fa=p[h*2+1],A=ja-aa,x=fa-F,M=void 0;if(A!==0||x!==0){M=((z-aa)*A+(za-F)*x)/(A*A+x*x);if(M>1){aa=ja;F=fa}else if(M>0){aa+=A*M;F+=x*M}}A=z-aa;
x=za-F;z=A*A+x*x;if(z>u){E=k;u=z}}if(u>2){C[E]=1;K.push(f);Z.push(E);K.push(E);Z.push(h)}f=K.pop();h=Z.pop()}for(k=0;k<y;k++)C[k]&&H.push(p[k*2],p[k*2+1]);return H}var Xa=Xa||Array,Wa=Wa||Array,U=Math,eb=U.exp,fb=U.log,P=U.sin,ba=U.cos,Aa=U.tan,Ya=U.asin,gb=U.atan,Za=U.atan2,na=U.min,Ma=U.max,Na=j.document,Q=function(){function p(f,h,k){if(k<0)k+=1;if(k>1)k-=1;if(k<1/6)return f+(h-f)*6*k;if(k<0.5)return h;if(k<2/3)return f+(h-f)*(2/3-k)*6;return f}function y(f,h,k,u){this.r=f;this.g=h;this.b=k;this.a=
arguments.length<4?1:u}var C=y.prototype;C.toString=function(){return"rgba("+[this.r<<0,this.g<<0,this.b<<0,this.a.toFixed(2)].join(",")+")"};C.adjustLightness=function(f){var h=Q.toHSLA(this);h.l*=f;h.l=Math.min(1,Math.max(0,h.l));var k,u;if(h.s===0)f=k=u=h.l;else{u=h.l<0.5?h.l*(1+h.s):h.l+h.s-h.l*h.s;var z=2*h.l-u;f=p(z,u,h.h+1/3);k=p(z,u,h.h);u=p(z,u,h.h-1/3)}return new Q(f*255<<0,k*255<<0,u*255<<0,h.a)};C.adjustAlpha=function(f){return new Q(this.r,this.g,this.b,this.a*f)};y.parse=function(f){f+=
"";if(~f.indexOf("#")){f=f.match(/^#?(\w{2})(\w{2})(\w{2})(\w{2})?$/);return new Q(parseInt(f[1],16),parseInt(f[2],16),parseInt(f[3],16),f[4]?parseInt(f[4],16)/255:1)}if(f=f.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new Q(parseInt(f[1],10),parseInt(f[2],10),parseInt(f[3],10),f[4]?parseFloat(f[5],10):1)};y.toHSLA=function(f){var h=f.r/255,k=f.g/255,u=f.b/255,z=Math.max(h,k,u),E=Math.min(h,k,u),K,Z=(z+E)/2,H;if(z===E)K=E=0;else{H=z-E;E=Z>0.5?H/(2-z-E):H/(z+E);switch(z){case h:K=(k-
u)/H+(k<u?6:0);break;case k:K=(u-h)/H+2;break;case u:K=(h-k)/H+4;break}K/=6}return{h:K,s:E,l:Z,a:f.a}};return y}(),ga=Math.PI,$a=ga/2,hb=ga/4,N=180/ga,ib=256,Oa=14,oa="latitude",pa="longitude",V=0,O=1,R=2,ca=3,Ba=4,qa=5,$=6;j.OSMBuildings=function(p){function y(a,c){var b={};a/=ra;c/=ra;b[oa]=c<=0?90:c>=1?-90:N*(2*gb(eb(ga*(1-2*c)))-$a);b[pa]=(a===1?1:(a%1+1)%1)*360-180;return b}function C(a,c){return a.replace(/\{ *([\w_]+) *\}/g,function(b,d){return c[d]})}function f(a,c,b,d,e){a=na(Ma(a,c),b);
return na(Ma(d+(a-c)/(b-c)*(e-d),d),e)}function h(a,c){var b=new XMLHttpRequest;b.onreadystatechange=function(){if(b.readyState===4)!b.status||b.status<200||b.status>299||b.responseText&&c(JSON.parse(b.responseText))};b.open("GET",a);b.send(null);return b}function k(){if(!(!Pa||S<Oa)){var a=y(W-M,X-Ca),c=y(W+A+M,X+x+Ca);Da&&Da.abort();Da=h(C(Pa,{w:a[pa],n:a[oa],e:c[pa],s:c[oa],z:S}),u)}}function u(a){var c,b,d,e=[],g,i=g=0;Ea=Oa;H(S);Da=null;if(!(!a||a.meta.z!==S)){d=a.meta;b=a.data;if(D&&B&&D.z===
d.z){g=D.x-d.x;i=D.y-d.y;a=0;for(c=B.length;a<c;a++)e[a]=B[a][R][0]+g+","+(B[a][R][1]+i)}D=d;B=[];a=0;for(c=b.length;a<c;a++){d=[];if(!(b[a][O]>sa)){g=Va(b[a][R]);if(!(g.length<8)){d[R]=g;d[Ba]=Ua(g);d[V]=na(b[a][V],sa);d[O]=b[a][O];g=d[R][0]+","+d[R][1];d[qa]=!(e&&~e.indexOf(g));d[ca]=[];d[$]=[];B.push(d)}}}aa()}}function z(a,c){var b=[],d,e,g,i,l,m,o,v,q,t=Qa-S;d=0;for(e=a.length;d<e;d++){l=a[d];v=l[O]>>t;if(!(v>sa)){m=l[R];q=new Xa(m.length);g=0;for(i=m.length-1;g<i;g+=2){o=m[g+1];var r=na(1,Ma(0,
0.5-fb(Aa(hb+$a*m[g]/180))/ga/2));o={x:(o/360+0.5)*ra<<0,y:r*ra<<0};q[g]=o.x;q[g+1]=o.y}q=Va(q);if(!(q.length<8)){i=[];i[R]=q;i[Ba]=Ua(q);i[V]=na(l[V]>>t,sa);i[O]=v;i[qa]=c;i[ca]=l[ca];i[$]=[];for(g=0;g<3;g++)if(i[ca][g])i[$][g]=i[ca][g].adjustAlpha(T)+"";b.push(i)}}}return b}function E(a,c){if(typeof a==="object")Z(a,!c);else{var b=Na.documentElement,d=Na.createElement("script");j.jsonpCallback=function(e){delete j.jsonpCallback;b.removeChild(d);Z(e,!c)};b.insertBefore(d,b.lastChild).src=a.replace(/\{callback\}/,
"jsonpCallback")}}function K(a,c,b){if(b===undefined)b=[];var d,e,g,i=a[0]?a:a.features,l,m,o,v,q,t=c?1:0,r=c?0:1;if(i){d=0;for(a=i.length;d<a;d++)K(i[d],c,b);return b}if(a.type==="Feature"){l=a.geometry;d=a.properties}if(l.type==="Polygon")m=[l.coordinates];if(l.type==="MultiPolygon")m=l.coordinates;if(m){c=d.height;if(d.color||d.wallColor)v=Q.parse(d.color||d.wallColor);if(d.roofColor)q=Q.parse(d.roofColor);d=0;for(a=m.length;d<a;d++){i=m[d][0];o=[];e=l=0;for(g=i.length;e<g;e++){o.push(i[e][t],
i[e][r]);l+=c||i[e][2]||0}if(l){e=[];g=R;var s=void 0,w=void 0,I=void 0,ka=void 0,ta=0,Y=void 0,ab=void 0;Y=0;for(ab=o.length-3;Y<ab;Y+=2){s=o[Y];w=o[Y+1];I=o[Y+2];ka=o[Y+3];ta+=s*ka-I*w}if((ta/2>0?"CW":"CCW")==="CW")o=o;else{s=[];for(w=o.length-2;w>=0;w-=2)s.push(o[w],o[w+1]);o=s}e[g]=o;e[V]=l/i.length<<0;e[ca]=[v||null,v?v.adjustLightness(0.8):null,q?q:v?v.adjustLightness(1.2):ha];b.push(e)}}}return b}function Z(a,c){if(a){ua=K(a,c);Ea=0;H(S);D={n:90,w:-180,s:-90,e:180,x:0,y:0,z:S};B=z(ua,true);
aa()}else{ua=null;F()}}function H(a){var c,b,d;S=a;ra=ib<<S;T=1-f(S,Ea,Qa,0,0.3);Fa=da.adjustAlpha(T)+"";Ga=Ha.adjustAlpha(T)+"";Ia=ha.adjustAlpha(T)+"";Ja=Ka.adjustAlpha(T)+"";if(B){a=0;for(c=B.length;a<c;a++){d=B[a];d[$]=[];for(b=0;b<3;b++)if(d[ca][b])d[$][b]=d[ca][b].adjustAlpha(T)+""}}}function za(){var a,c,b,d,e,g,i,l,m=W-D.x,o=X-D.y,v,q,t,r,s,w,I=[];n.fillStyle=Ja;a=0;for(c=B.length;a<c;a++){e=B[a];q=false;g=e[R];v=[];b=0;for(d=g.length-1;b<d;b+=2){v[b]=i=g[b]-m;v[b+1]=l=g[b+1]-o;q||(q=i>0&&
i<A&&l>0&&l<x)}if(q){g=e[V];if(e[O])g=e[O];i=null;n.beginPath();b=0;for(d=v.length-3;b<d;b+=2){l=v[b];t=v[b+1];q=v[b+2];r=v[b+3];s={x:l+va*g,y:t+wa*g};w={x:q+va*g,y:r+wa*g};if(e[O]){t={x:l+va*g,y:t+wa*g};r={x:q+va*g,y:r+wa*g};l=t.x;t=t.y;q=r.x;r=r.y}if((q-l)*(s.y-t)>(s.x-l)*(r-t)){i===1&&n.lineTo(l,t);i=0;b||n.moveTo(l,t);n.lineTo(q,r)}else{i===0&&n.lineTo(s.x,s.y);i=1;b||n.moveTo(s.x,s.y);n.lineTo(w.x,w.y)}}n.closePath();n.fill();I.push(v)}}n.fillStyle=Fa;a=0;for(c=I.length;a<c;a++)ja(I[a]);a=n.getImageData(0,
0,A,x);c=a.data;b=La*255<<0;m=0;for(o=c.length;m<o;m+=4){d=c[m+0];e=c[m+3];if(d&&e>=255)c[m+3]=0;else if(e>b)c[m+3]=b}n.putImageData(a,0,0);ea=new Image;ea.src=G.toDataURL()}function aa(){la=0;ea=null;clearInterval(Ra);Ra=setInterval(function(){la+=0.1;if(la>1){clearInterval(Ra);la=1;for(var a=0,c=B.length;a<c;a++)B[a][qa]=0}F()},33)}function F(){n.clearRect(0,0,A,x);if(D&&B)if(!(S<Ea||Sa)){if(Ta&&ia>-1)if(ea)n.drawImage(ea,bb-W,cb-X);else{za();bb=W;cb=X}var a,c,b,d,e,g,i,l,m,o=W-D.x,v=X-D.y,q=[xa+
o,ya+v],t,r,s,w,I,ka;B.sort(function(ta,Y){return J(Y[Ba],q)/Y[V]-J(ta[Ba],q)/ta[V]});a=0;for(c=B.length;a<c;a++){e=B[a];r=false;g=e[R];t=[];b=0;for(d=g.length-1;b<d;b+=2){t[b]=l=g[b]-o;t[b+1]=m=g[b+1]-v;r||(r=l>0&&l<A&&m>0&&m<x)}if(r){b=e[qa]?e[V]*la:e[V];g=ma/(ma-b);if(e[O]){b=e[qa]?e[O]*la:e[O];i=ma/(ma-b)}l=[];b=0;for(d=t.length-3;b<d;b+=2){m=t[b];s=t[b+1];r=t[b+2];w=t[b+3];I=fa(m,s,g);ka=fa(r,w,g);if(e[O]){s=fa(m,s,i);w=fa(r,w,i);m=s.x;s=s.y;r=w.x;w=w.y}if((r-m)*(I.y-s)>(I.x-m)*(w-s)){n.fillStyle=
m<r&&s<w||m>r&&s>w?e[$][1]||Ga:e[$][0]||Fa;ja([r,w,m,s,I.x,I.y,ka.x,ka.y])}l[b]=I.x;l[b+1]=I.y}n.fillStyle=e[$][2]||Ia;n.strokeStyle=e[$][1]||Ga;ja(l,true)}}if(Ta&&ia===-1){n.fillStyle=Ja;n.fillRect(0,0,A,x)}}}function ja(a,c){if(a.length){n.beginPath();n.moveTo(a[0],a[1]);for(var b=2,d=a.length;b<d;b+=2)n.lineTo(a[b],a[b+1]);n.closePath();c&&n.stroke();n.fill()}}function fa(a,c,b){return{x:(a-xa)*b+xa<<0,y:(c-ya)*b+ya<<0}}var A=0,x=0,M=0,Ca=0,W=0,X=0,S,ra,Da,G,n,Pa,da=new Q(200,190,180),Ha=da.adjustLightness(0.8),
ha=da.adjustLightness(1.2),Ka=new Q(0,0,0),Fa=da+"",Ga=Ha+"",Ia=ha+"",Ja=Ka+"",Ta=true,ua,D,B,la=1,Ra,T=1,Ea=Oa,Qa=20,sa,xa,ya,ma,Sa,bb,cb,ea,La=1,ia=-1,va=0,wa=0,jb=357.5291/N,kb=0.98560028/N,lb=1.9148/N,mb=0.02/N,nb=3.0E-4/N,ob=102.9372/N,db=23.45/N,pb=280.16/N,qb=360.9856235/N;this.setStyle=function(a){a=(a=a)||{};if(a.color||a.wallColor){da=Q.parse(a.color||a.wallColor);Fa=da.adjustAlpha(T)+"";Ha=da.adjustLightness(0.8);Ga=Ha.adjustAlpha(T)+"";ha=da.adjustLightness(1.2);Ia=ha.adjustAlpha(T)+""}if(a.roofColor){ha=
Q.parse(a.roofColor);Ia=ha.adjustAlpha(T)+""}if(a.shadows!==undefined)Ta=!!a.shadows;F();return this};this.geoJSON=function(a,c){E(a,c);return this};this.setCamOffset=function(a,c){xa=M+a;ya=x+c};this.setMaxZoom=function(a){Qa=a};this.createCanvas=function(a){G=Na.createElement("CANVAS");G.style.webkitTransform="translate3d(0,0,0)";G.style.imageRendering="optimizeSpeed";G.style.position="absolute";G.style.pointerEvents="none";G.style.left=0;G.style.top=0;a.appendChild(G);n=G.getContext("2d");n.lineCap=
"round";n.lineJoin="round";n.lineWidth=1;try{n.mozImageSmoothingEnabled=false}catch(c){}return G};this.destroyCanvas=function(){G.parentNode.removeChild(G)};this.loadData=k;this.onMoveEnd=function(){var a=y(W,X),c=y(W+A,X+x);ea=null;F();if(D&&(a[oa]>D.n||a[pa]<D.w||c[oa]<D.s||c[pa]>D.e))k()};this.onZoomEnd=function(a){Sa=false;H(a.zoom);if(ua){B=z(ua);ea=null;F()}else{F();k()}};this.onZoomStart=function(){Sa=true;F()};this.render=F;this.setOrigin=function(a,c){W=a;X=c};this.setSize=function(a,c){A=
a;x=c;M=A/2<<0;Ca=x/2<<0;xa=M;ya=x;ma=A/1.5/Aa(45)<<0;G.width=A;G.height=x;sa=ma-50};this.setZoom=H;this.setDate=function(a){var c,b;if(a){c=y(W+M,X+Ca);b=-c.longitude/N;c=c.latitude/N;a=a.valueOf()/864E5-0.5+2440588;var d=jb+kb*(a-2451545),e=lb*P(d)+mb*P(2*d)+nb*P(3*d);e=d+ob+e+ga;d=Ya(P(e)*P(db));e=Za(P(e)*ba(db),ba(e));b=pb+qb*(a-2451545)-b-e;b={altitude:Ya(P(c)*P(d)+ba(c)*ba(d)*ba(b)),azimuth:Za(P(b),ba(b)*P(c)-Aa(d)*ba(c))-ga/2};if(b.altitude<=0){ia=-1;La=f(-b.altitude,0,1,0.1,0.8)}else{ia=1/
Aa(b.altitude);La=0.4/ia;va=ba(b.azimuth)*ia;wa=P(b.azimuth)*ia}Ka.a=La;Ja=Ka+"";ea=null;F()}};Pa=p};j.OSMBuildings.VERSION="0.1.8a";j.OSMBuildings.ATTRIBUTION='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'})(this);
L.BuildingsLayer=L.Class.extend({map:null,osmb:null,canvas:null,blockMoveEvent:null,lastX:0,lastY:0,initialize:function(j){L.Util.setOptions(this,j)},onMove:function(){var j=L.DomUtil.getPosition(this.map._mapPane);this.osmb.setCamOffset(this.lastX-j.x,this.lastY-j.y);this.osmb.render()},onMoveEnd:function(){if(this.blockMoveEvent)this.blockMoveEvent=false;else{var j=L.DomUtil.getPosition(this.map._mapPane),J=this.map.getPixelOrigin();this.lastX=j.x;this.lastY=j.y;this.canvas.style.left=-j.x+"px";
this.canvas.style.top=-j.y+"px";this.osmb.setCamOffset(0,0);this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(J.x-j.x,J.y-j.y);this.osmb.onMoveEnd()}},onZoomStart:function(){this.osmb.onZoomStart()},onZoomEnd:function(){var j=L.DomUtil.getPosition(this.map._mapPane),J=this.map.getPixelOrigin();this.osmb.setOrigin(J.x-j.x,J.y-j.y);this.osmb.onZoomEnd({zoom:this.map._zoom});this.blockMoveEvent=true},addTo:function(j){j.addLayer(this);return this},onAdd:function(j){this.map=j;
this.osmb=new OSMBuildings(this.options.url);this.canvas=this.osmb.createCanvas(this.map._panes.overlayPane);this.osmb.maxZoom=this.map._layersMaxZoom;j=L.DomUtil.getPosition(this.map._mapPane);var J=this.map.getPixelOrigin();this.osmb.setSize(this.map._size.x,this.map._size.y);this.osmb.setOrigin(J.x-j.x,J.y-j.y);this.osmb.setZoom(this.map._zoom);this.canvas.style.left=-j.x+"px";this.canvas.style.top=-j.y+"px";this.map.on({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},
this);if(this.map.options.zoomAnimation)this.canvas.className="leaflet-zoom-animated";this.map.attributionControl.addAttribution(OSMBuildings.ATTRIBUTION);this.osmb.loadData();this.osmb.render()},onRemove:function(j){j.attributionControl.removeAttribution(OSMBuildings.ATTRIBUTION);j.off({move:this.onMove,moveend:this.onMoveEnd,zoomstart:this.onZoomStart,zoomend:this.onZoomEnd},this);this.canvas=this.osmb.destroyCanvas();this.osmb=this.map=null},geoJSON:function(j,J){return this.osmb.geoJSON(j,J)},
setStyle:function(j){return this.osmb.setStyle(j)},setDate:function(j){return this.osmb.setDate(j)}});
